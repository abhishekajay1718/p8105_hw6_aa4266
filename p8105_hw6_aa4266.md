P8105\_HW6\_AA4266
================
Abhishek Ajay (aa4266)
November 25, 2018

Problem 1
=========

Here we work on the homicides data from 50 large U.S. cities that has been gathered by The Washington Post.

**Data Import**

``` r
hom_data = 
  read_csv("./data/homicide-data.csv") %>% 
  mutate(city_state = paste(city, state, sep = ", "), 
         disposition = as.factor(disposition),
         bin_disposition = as.numeric(disposition == "Closed by arrest")) %>% 
  filter(!(city_state %in% c("Dallas, TX", "Phoenix, AZ", "Kansas City, MO", "Tulsa, AL"))) %>% 
  mutate(victim_race = as.factor(ifelse(victim_race == "White", "white", "non-white")), 
         victim_age = as.numeric(victim_age))
```

    ## Parsed with column specification:
    ## cols(
    ##   uid = col_character(),
    ##   reported_date = col_integer(),
    ##   victim_last = col_character(),
    ##   victim_first = col_character(),
    ##   victim_race = col_character(),
    ##   victim_age = col_character(),
    ##   victim_sex = col_character(),
    ##   city = col_character(),
    ##   state = col_character(),
    ##   lat = col_double(),
    ##   lon = col_double(),
    ##   disposition = col_character()
    ## )

    ## Warning in evalq(as.numeric(victim_age), <environment>): NAs introduced by
    ## coercion

In bin\_disposition, **1** means, Closed by arrest and **0** means elsewise.

Now we fit a logistic regression with resolved vs unresolved as the outcome and victim age, sex and race as predictors.

``` r
fit_logistic_baltimore_white_OR = 
  hom_data %>% 
  filter(city_state == "Baltimore, MD") %>% 
  glm(bin_disposition ~ victim_age + victim_sex + victim_race, data = ., family = binomial()) %>% 
  broom::tidy() %>% 
  filter(term == "victim_racewhite") %>% 
  mutate(OR = exp(estimate), CI_OR_0.025 = OR - 1.96 * std.error, CI_OR_0.975 = OR + 1.96 * std.error) #95% CI, therefore alpha is 1.96

fit_logistic_baltimore_white_OR %>% 
  knitr::kable(digits = 3)
```

| term              |  estimate|  std.error|  statistic|  p.value|    OR|  CI\_OR\_0.025|  CI\_OR\_0.975|
|:------------------|---------:|----------:|----------:|--------:|-----:|--------------:|--------------:|
| victim\_racewhite |      0.82|      0.175|      4.694|        0|  2.27|          1.927|          2.612|

Now run glm for each of the cities in your dataset, and extract the adjusted odds ratio (and CI) for solving homicides comparing non-white victims to white victims. Do this within a “tidy” pipeline, making use of purrr::map, list columns, and unnest as necessary to create a dataframe with estimated ORs and CIs for each city.

``` r
fit_logistic_all_white_OR = 
  hom_data %>% 
  group_by(city_state) %>% 
  nest() %>% 
  mutate(models = map(data, ~glm(bin_disposition ~ victim_age + victim_sex + victim_race, data = ., family = binomial())), 
         results = map(models, broom::tidy)) %>% 
  select(-data, -models) %>% 
  unnest() %>% 
  filter(term == "victim_racewhite") %>% 
  mutate(OR = exp(estimate), CI_OR_0.025 = OR - 1.96 * std.error, CI_OR_0.975 = OR + 1.96 * std.error) %>% #95% CI, therefore alpha is 1.96
  arrange(desc(OR))
  
fit_logistic_all_white_OR %>% 
  head() %>% 
  knitr::kable()
```

| city\_state    | term              |   estimate|  std.error|  statistic|    p.value|        OR|  CI\_OR\_0.025|  CI\_OR\_0.975|
|:---------------|:------------------|----------:|----------:|----------:|----------:|---------:|--------------:|--------------:|
| Boston, MA     | victim\_racewhite |  2.1667164|  0.4528769|   4.784338|  0.0000017|  8.729573|       7.841934|       9.617212|
| Omaha, NE      | victim\_racewhite |  1.7783134|  0.3017037|   5.894237|  0.0000000|  5.919863|       5.328524|       6.511203|
| Oakland, CA    | victim\_racewhite |  1.5465668|  0.3639485|   4.249411|  0.0000214|  4.695323|       3.981983|       5.408662|
| Pittsburgh, PA | victim\_racewhite |  1.2674074|  0.2859816|   4.431780|  0.0000093|  3.551633|       2.991109|       4.112157|
| Cincinnati, OH | victim\_racewhite |  1.1445849|  0.2797127|   4.092002|  0.0000428|  3.141137|       2.592900|       3.689374|
| Stockton, CA   | victim\_racewhite |  0.9789109|  0.3309013|   2.958317|  0.0030932|  2.661556|       2.012990|       3.310123|

The above table shows the top 6 cities with the highest odds ratio of solving homicides comparing non-white victims to white victims.

Following will be a plot that shows the estimated ORs and CIs for each city. Organize cities according to estimated OR, and comment on the plot.

``` r
fit_logistic_all_white_OR %>% 
  mutate(city_state = as.factor(city_state), city_state = fct_reorder(city_state, desc(OR))) %>% 
  ggplot(aes(x = city_state, y = OR)) +
  geom_point() + 
  geom_errorbar(aes(ymin = CI_OR_0.025, ymax = CI_OR_0.975)) +
  theme(axis.text.x = element_text(color = "#993333", angle = 90, size = rel(0.8), hjust = 1))
```

<img src="p8105_hw6_aa4266_files/figure-markdown_github/p1_all_cities_glm_plot-1.png" width="90%" />
